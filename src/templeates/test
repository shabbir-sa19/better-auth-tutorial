// app/api/users-actions/route.js

import { NextRequest, NextResponse } from "next/server";

// Input validation helper
const validateRegistrationInput = (data: any) => {
  const errors = [];

  // Name validation
  if (!data.name || data.name.trim().length < 2) {
    errors.push("Name must be at least 2 characters long");
  }

  // Email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!data.email || !emailRegex.test(data.email)) {
    errors.push("Valid email is required");
  }

  // Password validation
  if (!data.password || data.password.length < 6) {
    errors.push("Password must be at least 6 characters long");
  }

  return errors;
};

export async function POST(request: NextRequest) {
  try {
    // Parse JSON body
    const body = await request.json();
    const { name, email, password } = body;

    // Validate required fields
    if (!name || !email || !password) {
      return NextResponse.json(
        {
          success: false,
          message: "All fields are required",
          errors: ["Name, email, and password are required"],
        },
        { status: 400 }
      );
    }

    // Validate input data
    const validationErrors = validateRegistrationInput(body);
    if (validationErrors.length > 0) {
      return NextResponse.json(
        {
          success: false,
          message: "Validation failed",
          errors: validationErrors,
        },
        { status: 400 }
      );
    }

    // Connect to database
    await connectToDatabase();

    // Check if user already exists
    const existingUser = await User.findOne({
      email: email.toLowerCase().trim(),
    });

    if (existingUser) {
      return NextResponse.json(
        {
          success: false,
          message: "Registration failed",
          errors: ["User with this email already exists"],
        },
        { status: 409 }
      );
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 12);

    // Create new user
    const newUser = new User({
      name: name.trim(),
      email: email.toLowerCase().trim(),
      password: hashedPassword,
    });

    // Save user to database
    const savedUser = await newUser.save();

    // Remove password from response
    const userResponse = {
      id: savedUser._id,
      name: savedUser.name,
      email: savedUser.email,
      createdAt: savedUser.createdAt,
      updatedAt: savedUser.updatedAt,
    };

    return NextResponse.json(
      {
        success: true,
        message: "User registered successfully",
        data: userResponse,
      },
      { status: 201 }
    );
  } catch (error) {
    console.error("Registration error:", error);

    // Handle duplicate key errors (if unique index on email)
    if (error.code === 11000) {
      return NextResponse.json(
        {
          success: false,
          message: "Registration failed",
          errors: ["User with this email already exists"],
        },
        { status: 409 }
      );
    }

    // Handle validation errors from mongoose
    if (error.name === "ValidationError") {
      const errors = Object.values(error.errors).map((err) => err.message);
      return NextResponse.json(
        {
          success: false,
          message: "Validation failed",
          errors,
        },
        { status: 400 }
      );
    }

    // Generic server error
    return NextResponse.json(
      {
        success: false,
        message: "Internal server error",
        errors: ["An unexpected error occurred"],
      },
      { status: 500 }
    );
  }
}

// Optional: GET handler to retrieve users (for testing)
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const email = searchParams.get("email");

    let users;
    if (email) {
      users = await User.findOne({ email }).select("-password");
    } else {
      users = await User.find({}).select("-password");
    }

    return NextResponse.json(
      {
        success: true,
        data: users,
      },
      { status: 200 }
    );
  } catch (error) {
    console.error("GET users error:", error);
    return NextResponse.json(
      {
        success: false,
        message: "Failed to retrieve users",
      },
      { status: 500 }
    );
  }
}
